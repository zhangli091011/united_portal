# 飞书多维表格配置指南

## 🚀 自动创建表格（推荐）

使用我们提供的自动化脚本来创建符合要求的飞书多维表格：

```bash
npm run create-table
```

脚本将引导您完成以下步骤：
1. 输入飞书 App ID 和 App Secret
2. 选择创建新应用或使用现有应用
3. 自动创建所有必需的字段
4. 验证表格结构
5. 生成配置代码

## 🛠️ 手动创建表格

如果您喜欢手动创建，请按照以下步骤：

### 1. 创建飞书应用

1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 创建企业应用
3. 获取 App ID 和 App Secret
4. 配置应用权限：
   - `bitable:app` - 多维表格应用权限
   - `authen:user_info` - 用户信息权限

### 2. 创建多维表格

1. 在飞书中创建新的多维表格
2. 记录 App Token 和 Table ID

### 3. 配置表格字段

创建以下字段（字段名称必须完全匹配）：

#### 基础信息字段
| 字段名称 | 字段类型 | 说明 |
|---------|---------|------|
| 参演单位 | 文本 | 主字段，报名单位名称 |
| 作品名称 | 文本 | 节目名称 |
| 演职人员 | 文本 | 参与演出的人员 |
| 参演单位负责人联系方式 | 数字 | QQ号码 |

#### 节目类型字段
| 字段名称 | 字段类型 | 选项 |
|---------|---------|------|
| 作品类型 | 单选 | 公益短片（非合作方请不要选择此项）、小品、相声、乐器、戏曲、说唱、舞蹈、歌曲、魔术、杂技、《难忘今宵》合唱、混剪、其他、公益短片 |
| 作品类型-其他-补充内容 | 文本 | 其他类型的补充说明 |
| 作品类型-乐器-補充內容 | 文本 | 乐器类型的补充说明 |

#### 状态管理字段
| 字段名称 | 字段类型 | 选项 |
|---------|---------|------|
| 作品状态 | 多选 | 未按规范填写表格、作品所有者自愿取消、已联系、有待斟酌、一审通过、二审通过、终审通过、初审驳回、团队独立立项、拒绝联系、无法联系 |
| 演职人员是否出镜 | 单选 | 是、否 |
| 备注 | 文本 | 管理员备注信息 |

#### 版权确认字段
| 字段名称 | 字段类型 | 选项 |
|---------|---------|------|
| 请确定您所报名的节目为自创，或已受到原创授权的节目 | 多选 | 我确定！、自行视频录制、符合版权法的授权、其他版权类型 |
| 请确定您所报名的节目为自创，或已受到原创授权的节目-其他版权类型-补充内容 | 文本 | 其他版权类型说明 |

#### 系统字段
| 字段名称 | 字段类型 | 配置 |
|---------|---------|------|
| 编号 | 自动编号 | 格式：26ZCW + yyyyMMdd + 3位序号 |
| 日期（自动化筛选条件） | 日期时间 | 自动填充，格式：yyyy/MM/dd HH:mm |
| 信息统计 | 单选 | 已进入合唱群、1 |
| 团队直辖作品发展成员 | 多选 | 初选、审查、定稿 |

## 🔧 配置系统

### 1. 更新配置文件

将获取到的信息填入 `server/config.js`：

```javascript
feishu: {
  appId: 'your_app_id_here',
  appSecret: 'your_app_secret_here',
  bitableAppToken: 'your_app_token_here',
  tableId: 'your_table_id_here'
}
```

### 2. 配置回调地址

在飞书应用设置中添加重定向URL：
- 开发环境：`http://localhost:5173/admin/login`
- 生产环境：`https://your-domain.com/admin/login`

## 🧪 测试配置

### 1. 测试API连接
```bash
# 启动开发服务器
npm run dev

# 在浏览器中访问
http://localhost:5173
```

### 2. 测试报名功能
1. 点击"报名"卡片
2. 填写测试数据
3. 提交报名
4. 检查飞书表格中是否有新记录

### 3. 测试查询功能
1. 使用生成的报名编号
2. 在"查询"页面输入编号
3. 验证能否正确显示报名信息

### 4. 测试管理员功能
1. 访问 `/admin/login`
2. 使用员工编码登录或飞书登录
3. 检查能否看到报名列表
4. 测试审核功能

## 🔍 故障排除

### 常见错误

1. **"Cannot read properties of undefined (reading 'record')"**
   - 检查飞书API返回的数据结构
   - 确认App Token和Table ID正确
   - 检查应用权限配置

2. **"飞书API返回错误"**
   - 检查App ID和App Secret
   - 确认表格字段名称完全匹配
   - 检查网络连接

3. **"报名编号格式错误"**
   - 确认自动编号字段配置正确
   - 检查编号格式：26ZCW + 日期 + 序号

### 调试步骤

1. **检查API响应**
   ```bash
   # 查看服务器日志
   npm run server:dev
   ```

2. **验证表格结构**
   ```bash
   # 运行表格验证脚本
   npm run create-table
   # 选择验证现有表格
   ```

3. **测试飞书连接**
   - 使用飞书开放平台的API调试工具
   - 验证访问令牌是否有效

## 📚 相关文档

- [飞书开放平台文档](https://open.feishu.cn/document/)
- [多维表格API](https://open.feishu.cn/document/server-docs/docs/bitable-v1/app/create)
- [身份验证](https://open.feishu.cn/document/server-docs/authentication/access-token/tenant_access_token_internal)

## 💡 最佳实践

1. **权限管理**
   - 只授予必要的最小权限
   - 定期检查和更新权限

2. **数据安全**
   - 定期备份多维表格数据
   - 设置适当的访问权限

3. **性能优化**
   - 合理设置API请求频率
   - 使用缓存减少重复请求

4. **监控告警**
   - 监控API调用状态
   - 设置错误告警机制

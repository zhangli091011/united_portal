# 中春晚报名系统 - 正式部署指南

## 📋 部署概览

本指南将帮助您在生产环境中完整部署中春晚报名系统，包括前端React应用、Node.js后端服务、数据库配置、SSL证书、监控等完整的生产环境配置。

## 🎯 部署目标

- **高可用性**: 系统稳定运行，支持7x24小时服务
- **安全性**: HTTPS加密、权限管理、数据保护
- **性能**: 响应速度快，支持高并发访问
- **可维护性**: 便于监控、日志查看、问题排查

## 📦 系统架构

```
                    [用户]
                      ↓
                  [Nginx反向代理]
                   ↙        ↘
            [前端应用]    [后端API]
                             ↓
                        [MySQL数据库]
                             ↓
                        [飞书API集成]
```

## 🛠 部署环境要求

### 最低配置要求
- **CPU**: 2核心
- **内存**: 4GB RAM  
- **存储**: 20GB 可用空间
- **网络**: 稳定的互联网连接
- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / Windows Server 2019+

### 推荐生产配置
- **CPU**: 4核心以上
- **内存**: 8GB RAM以上
- **存储**: 50GB SSD
- **带宽**: 10Mbps上行/下行
- **备份**: 定期数据备份策略

### 软件环境要求
- **Docker**: 20.10+
- **Docker Compose**: 2.0+
- **域名**: 已解析到服务器IP的域名
- **SSL证书**: Let's Encrypt或商业证书

## 🚀 部署步骤

### 第一步：环境准备

#### 1.1 服务器初始化
```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git vim unzip

# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 启动Docker服务
sudo systemctl enable docker
sudo systemctl start docker
```

#### 1.2 防火墙配置
```bash
# Ubuntu UFW
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 第二步：代码部署

#### 2.1 获取项目代码
```bash
# 克隆项目到服务器
cd /opt
sudo git clone https://github.com/your-repo/united-portal.git
sudo chown -R $USER:$USER united-portal
cd united-portal
```

#### 2.2 配置环境变量
```bash
# 复制生产环境配置模板
cp deploy/env.production.example server/.env.production

# 编辑配置文件
nano server/.env.production
```

**必需的环境变量配置**：
```env
# 基础服务配置
NODE_ENV=production
PORT=3001
HOST=0.0.0.0
FRONTEND_URL=https://your-domain.com

# JWT安全密钥（必须修改）
JWT_SECRET=your-super-secret-jwt-key-at-least-32-characters

# 管理员账号（首次部署后请修改）
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-strong-admin-password

# MySQL数据库配置
DB_HOST=103.216.175.227
DB_USER=users  
DB_PASSWORD=dcLt2XSHNHaXepC7
DB_NAME=users
DB_PORT=3306

# 飞书API配置
FEISHU_APP_ID=your-feishu-app-id
FEISHU_APP_SECRET=your-feishu-app-secret
FEISHU_BITABLE_APP_TOKEN=your-bitable-app-token
FEISHU_TABLE_ID=your-table-id

# 邮件服务配置（QQ邮箱示例）
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@qq.com
SMTP_PASS=your-qq-authorization-code

# Redis缓存配置（可选）
REDIS_PASSWORD=your-redis-password

# 文件上传限制
UPLOAD_MAX_SIZE=10485760
UPLOAD_ALLOWED_TYPES=image/jpeg,image/png,image/gif,image/webp

# 日志配置
LOG_LEVEL=info
LOG_FILE=logs/app.log
```

### 第三步：SSL证书配置

#### 3.1 使用Let's Encrypt免费证书（推荐）
```bash
# 安装Certbot
sudo apt install certbot

# 申请证书
sudo certbot certonly --webroot \
  --webroot-path=/var/www/html \
  --email your-email@domain.com \
  --agree-tos \
  --no-eff-email \
  -d your-domain.com \
  -d www.your-domain.com

# 创建SSL目录并复制证书
sudo mkdir -p /opt/united-portal/deploy/ssl
sudo cp /etc/letsencrypt/live/your-domain.com/fullchain.pem /opt/united-portal/deploy/ssl/
sudo cp /etc/letsencrypt/live/your-domain.com/privkey.pem /opt/united-portal/deploy/ssl/
sudo chown -R $USER:$USER /opt/united-portal/deploy/ssl
```

#### 3.2 设置证书自动续期
```bash
# 添加续期任务到crontab
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo tee -a /etc/crontab
```

### 第四步：Nginx配置

#### 4.1 更新Nginx配置文件
```bash
# 编辑Nginx配置，替换域名
sed -i 's/your-domain.com/实际域名/g' deploy/nginx.conf
```

### 第五步：数据库初始化

#### 5.1 MySQL数据库准备
系统使用外部MySQL数据库，确保数据库连接信息正确配置在环境变量中。

数据库表结构会在应用启动时自动创建，包括：
- `users` - 用户管理表
- `permissions` - 权限管理表  
- `user_sessions` - 用户会话表

### 第六步：执行部署

#### 6.1 Linux/macOS 系统部署
```bash
# 赋予执行权限
chmod +x deploy/deploy.sh

# 执行部署脚本
./deploy/deploy.sh production
```

#### 6.2 Windows 系统部署
```powershell
# 设置执行策略
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# 执行部署脚本
.\deploy\deploy.ps1 production
```

#### 6.3 手动部署（可选）
```bash
# 构建应用
docker-compose -f deploy/docker-compose.production.yml build

# 启动服务
docker-compose -f deploy/docker-compose.production.yml up -d

# 检查服务状态
docker-compose -f deploy/docker-compose.production.yml ps
```

### 第七步：部署验证

#### 7.1 服务健康检查
```bash
# 检查所有容器状态
docker-compose ps

# 检查API健康状态
curl -f https://your-domain.com/api/health

# 应该返回: {"status":"ok","timestamp":"..."}
```

#### 7.2 功能验证清单
- [ ] 前端页面正常访问 (https://your-domain.com)
- [ ] API健康检查返回200 (https://your-domain.com/api/health)
- [ ] 管理员登录功能正常
- [ ] 报名提交功能正常
- [ ] 邮件通知发送正常
- [ ] 飞书数据同步正常
- [ ] SSL证书有效

#### 7.3 测试管理员登录
1. 访问: `https://your-domain.com/admin/login`
2. 选择"用户名登录"
3. 用户名: `admin` (或您设置的用户名)
4. 密码: 您在环境变量中设置的密码

## 🔧 服务管理

### 常用Docker Compose命令
```bash
# 查看服务状态
docker-compose ps

# 查看实时日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f app

# 重启服务
docker-compose restart

# 停止服务
docker-compose down

# 更新并重启服务
docker-compose pull && docker-compose up -d
```

### 系统监控
```bash
# 查看系统资源使用
docker stats

# 查看磁盘使用
df -h

# 查看内存使用
free -h

# 查看网络连接
netstat -tlnp
```

## 📊 日志管理

### 日志文件位置
- **应用日志**: `./logs/app.log`
- **Nginx访问日志**: 通过`docker-compose logs nginx`查看
- **Nginx错误日志**: 通过`docker-compose logs nginx`查看
- **系统日志**: `/var/log/`

### 日志查看命令
```bash
# 查看应用日志
tail -f logs/app.log

# 查看最近100行日志
docker-compose logs --tail=100

# 查看特定时间的日志
docker-compose logs --since="2024-01-01T00:00:00Z"
```

### 日志轮转配置
```bash
# 创建logrotate配置
sudo tee /etc/logrotate.d/united-portal << EOF
/opt/united-portal/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
}
EOF
```

## 🔄 备份策略

### 自动备份脚本
```bash
#!/bin/bash
# 创建备份脚本
cat > /opt/backup-united-portal.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="/backup/united-portal"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_PATH="$BACKUP_DIR/$DATE"

# 创建备份目录
mkdir -p "$BACKUP_PATH"

# 备份应用文件
cp -r /opt/united-portal/uploads "$BACKUP_PATH/" 2>/dev/null || true
cp -r /opt/united-portal/logs "$BACKUP_PATH/" 2>/dev/null || true
cp /opt/united-portal/server/.env.production "$BACKUP_PATH/" 2>/dev/null || true

# 备份数据库（如果需要）
# mysqldump -h 103.216.175.227 -u users -p users > "$BACKUP_PATH/database.sql"

# 压缩备份
cd "$BACKUP_DIR"
tar -czf "united-portal-backup-$DATE.tar.gz" "$DATE"
rm -rf "$DATE"

# 删除30天前的备份
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete

echo "备份完成: united-portal-backup-$DATE.tar.gz"
EOF

# 设置执行权限
chmod +x /opt/backup-united-portal.sh

# 添加到定时任务（每日凌晨2点执行）
echo "0 2 * * * /opt/backup-united-portal.sh" | sudo tee -a /etc/crontab
```

## 🔄 更新部署

### 常规更新流程
```bash
# 1. 备份当前版本
./backup-united-portal.sh

# 2. 拉取最新代码
git pull origin main

# 3. 重新部署
./deploy/deploy.sh production

# 4. 验证更新
curl -f https://your-domain.com/api/health
```

### 回滚到之前版本
```bash
# 查看可用版本
git tag

# 回滚到特定版本
git checkout v1.0.0

# 重新部署
./deploy/deploy.sh production
```

## 🛡️ 安全加固

### 系统安全
```bash
# 禁用root SSH登录
sudo sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sudo systemctl restart ssh

# 设置密钥登录
# （推荐生成SSH密钥对并禁用密码登录）

# 安装自动安全更新
sudo apt install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

### 应用安全
1. **定期更新密码**: 登录后立即修改默认管理员密码
2. **JWT密钥安全**: 使用强随机密钥，定期轮换
3. **权限最小化**: 只分配必要的用户权限
4. **访问日志监控**: 定期检查访问日志异常

### SSL安全配置
Nginx配置已包含推荐的SSL安全设置：
- TLS 1.2+加密
- 强加密套件
- HSTS头部
- 安全响应头

## 🚨 故障排除

### 常见问题诊断

#### 1. 服务无法启动
```bash
# 检查Docker服务状态
sudo systemctl status docker

# 检查端口占用
sudo netstat -tlnp | grep :3001
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :443

# 检查配置文件语法
docker-compose config

# 查看详细错误日志
docker-compose logs
```

#### 2. 数据库连接失败
```bash
# 测试数据库连接
mysql -h 103.216.175.227 -u users -p users

# 检查网络连接
ping 103.216.175.227
telnet 103.216.175.227 3306

# 检查环境变量
grep DB_ server/.env.production
```

#### 3. 飞书API连接问题
```bash
# 检查飞书配置
grep FEISHU_ server/.env.production

# 测试网络连接
curl -v https://open.feishu.cn/open-apis/auth/v3/app_access_token/internal
```

#### 4. 邮件发送失败
```bash
# 检查SMTP配置
grep SMTP_ server/.env.production

# 测试SMTP连接
telnet smtp.qq.com 587
```

#### 5. SSL证书问题
```bash
# 检查证书有效期
openssl x509 -in deploy/ssl/fullchain.pem -text -noout

# 测试SSL连接
openssl s_client -connect your-domain.com:443

# 检查证书自动续期
sudo certbot certificates
```

### 应急处理流程

#### 服务完全不可用
```bash
# 1. 立即回滚到上一个工作版本
git log --oneline -10
git checkout <last-working-commit>
./deploy/deploy.sh production

# 2. 恢复数据备份（如需要）
# tar -xzf /backup/united-portal/latest-backup.tar.gz

# 3. 检查并修复问题
docker-compose logs
```

#### 部分功能异常
```bash
# 1. 重启特定服务
docker-compose restart app

# 2. 检查服务状态
docker-compose ps
curl -f https://your-domain.com/api/health

# 3. 查看错误日志
docker-compose logs app | grep ERROR
```

## 📈 性能优化

### 服务器性能调优
```bash
# 调整文件描述符限制
echo "* soft nofile 65536" | sudo tee -a /etc/security/limits.conf
echo "* hard nofile 65536" | sudo tee -a /etc/security/limits.conf

# 优化内核参数
echo "net.core.somaxconn = 65536" | sudo tee -a /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 65536" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### 应用性能优化
1. **启用Redis缓存**: 取消docker-compose.yml中Redis服务的注释
2. **Nginx缓存**: 配置静态资源缓存策略
3. **Gzip压缩**: Nginx配置已启用Gzip压缩
4. **CDN加速**: 可选择将静态资源托管到CDN

### 监控指标
```bash
# 创建监控脚本
cat > monitor.sh << 'EOF'
#!/bin/bash
echo "=== 系统监控报告 $(date) ==="
echo "CPU使用率:"
top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1

echo "内存使用率:"
free | grep Mem | awk '{printf("%.2f%%\n", $3/$2 * 100.0)}'

echo "磁盘使用率:"
df -h / | awk 'NR==2{printf "%s\n", $5}'

echo "Docker容器状态:"
docker-compose ps

echo "API健康检查:"
curl -s https://your-domain.com/api/health || echo "API不可用"
EOF

chmod +x monitor.sh
```

## 📞 技术支持

### 联系方式
- **GitHub Issues**: 项目问题和bug报告
- **技术支持邮箱**: your-support@domain.com
- **紧急联系**: +86-xxx-xxxx-xxxx

### 服务时间
- **标准支持**: 工作日 9:00-18:00
- **紧急支持**: 7x24小时（生产环境故障）

### 支持级别
1. **Level 1**: 基础咨询和使用问题
2. **Level 2**: 配置和部署问题
3. **Level 3**: 系统故障和紧急处理

## ✅ 部署检查清单

### 部署前检查
- [ ] 服务器资源满足要求
- [ ] 域名DNS解析正确
- [ ] SSL证书准备完毕
- [ ] 数据库连接信息确认
- [ ] 飞书API配置准备
- [ ] 邮件服务配置准备
- [ ] 环境变量文件配置完成

### 部署中检查
- [ ] 代码成功克隆到服务器
- [ ] Docker和Docker Compose安装正确
- [ ] 环境变量配置无误
- [ ] SSL证书路径正确
- [ ] 防火墙规则设置
- [ ] 服务成功启动

### 部署后验证
- [ ] 前端页面正常访问
- [ ] API健康检查通过
- [ ] 管理员登录功能正常
- [ ] 报名功能测试通过
- [ ] 邮件通知发送正常
- [ ] 数据库连接正常
- [ ] 日志记录正常
- [ ] 备份脚本设置完成
- [ ] 监控告警配置

### 安全检查
- [ ] 默认密码已修改
- [ ] JWT密钥已设置
- [ ] SSL证书有效
- [ ] 防火墙配置正确
- [ ] 系统安全更新启用
- [ ] 访问日志监控设置

---

## 🎉 部署完成

恭喜！您已经成功完成了中春晚报名系统的生产环境部署。

系统现在包含以下功能：
- ✅ 用户报名和状态查询
- ✅ 管理员后台管理
- ✅ 新闻中心和RSS集成
- ✅ 邮件通知系统
- ✅ 飞书数据同步
- ✅ 安全认证和权限管理
- ✅ 监控和日志系统
- ✅ 自动备份机制

### 下一步建议
1. **修改默认密码**: 立即登录后台修改管理员密码
2. **创建用户权限**: 根据需要创建不同权限的管理员
3. **测试完整流程**: 完整测试报名到审核的全流程
4. **设置监控告警**: 配置系统监控和告警通知
5. **定期备份验证**: 定期验证备份文件的完整性

祝您使用愉快！🚀
